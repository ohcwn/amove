const hash=(()=>{class b extends Map{constructor(){super();this.cache="";this.ignore=0;this.callbacks=new Set;this.read();window.addEventListener("hashchange",()=>{this.ignore?--this.ignore:(this.read(),this.callCallbacks())},{passive:!0})}addCallback(a){this.callbacks.add(a);return this}hasCallback(a){return this.callbacks.has(a)}delCallback(a){return this.callbacks.delete(a)}callCallbacks(){this.callbacks.forEach(a=>{a()})}read(){const a=window.location.hash.substring(1);this.cache!==a&&(super.clear(),
a&&(a.split("&").forEach(d=>{super.set(...d.split("-",2))}),this.cache=a,this.write()))}write(){let a="";const d=[...super.entries()];d.sort((c,e)=>c[0]>e[0]?1:-1);d.forEach(([c,e])=>{a&&(a+="&");a+=`${c}`;"undefined"!==typeof e&&(a+=`-${e}`)});a!==this.cache&&(this.cache=a,++this.ignore,window.location.hash=a)}has(a){return"id"===a?super.has("serial")||super.has("move"):super.has(a)}get(a){if("id"===a){if(super.has("serial"))return`serial-${super.get("serial")}`;if(super.has("move"))return`move-${super.get("move")}`}return super.get(a)}set(a,
d){if("id"===a){if("string"!==typeof d)return this;0===d.indexOf("serial-")?(super.delete("move"),super.set("serial",d.substring(7)),this.write()):0===d.indexOf("move-")&&(super.delete("serial"),super.set("move",d.substring(5)),this.write());return this}super.set(a,d);this.write();return this}delete(a){(a="id"===a?super.delete("serial")||super.delete("move"):super.delete(a))&&this.write();return a}clear(){const a=super.get("bg");super.clear();""!==this.cache&&(this.cache="",++this.ignore,window.location.hash=
"");a&&this.set("bg",a)}}return new b})();let items=new Map;
const parse=b=>{const a=new Map,d=["worldart_link","shikimori_id","kinopoisk_id","imdb_id","mdl_id"];b.forEach(c=>{var e=d.find(f=>c[f]);e=e?`${e}-${c[e]}`:`tyt-${c.type}${c.year}${c.title_orig}`;if(a.has(e))a.get(e).top.last_episode<c.last_episode&&(a.get(e).top=c,a.get(e).ep=c.last_episode);else{let f,g;const h=(null==(f=c.material_data)?void 0:f.anime_poster_url)||(null==(g=c.material_data)?void 0:g.poster_url)||"no-img.jpg";a.set(e,{key:e,img:h,y:c.year,ep:c.last_episode,top:c,raw:new Map,tr:new Map})}a.get(e).raw.set(c.id,
c);a.get(e).tr.set(c.translation.id,c.id)});return a},buildString=b=>{const {top:a}=b;let d="";b.y&&(d+=`${b.y}\u0433. `);b.ep&&(d+=`${b.ep} \u044d\u043f. `);let c="";b.raw.forEach(e=>{""!==c&&(c+=", ");c=e===a?c+`<span class="underline">${e.translation.title}</span>`:c+e.translation.title;e.last_episode&&(c+=`[${e.last_episode}]`)});return d+c},buildLinks=b=>{const a=[];var d=e=>e?` ${e}`:"";if(b.shikimori_id){var c;const e=d(null==(c=b.material_data)?void 0:c.shikimori_rating);a.push(`<a href="https://shikimori.one/animes/${b.shikimori_id}" target="_blank" rel="noreferrer">shikimori${e}</a>`)}b.worldart_link&&
a.push(`<a href="${b.worldart_link}" target="_blank" rel="noreferrer">worldart</a>`);if(b.kinopoisk_id){let e;c=d(null==(e=b.material_data)?void 0:e.kinopoisk_rating);a.push(`<a href="https://www.kinopoisk.ru/film/${b.kinopoisk_id}" target="_blank" rel="noreferrer">kinopoisk${c}</a>`)}if(b.imdb_id){let e;d=d(null==(e=b.material_data)?void 0:e.imdb_rating);a.push(`<a href="https://www.imdb.com/title/${b.imdb_id}" target="_blank" rel="noreferrer">imdb${d}</a>`)}return a.join(", ")},buildHTML=b=>{let a=
"";b.forEach((d,c)=>{const {top:e}=d;let f,g,h;a+=`<div class="item" data-key="${c}">
<div class="left">
<div class="poster-wrapper">
  <img class="poster" src="${d.img}" alt="" />
</div>
<div class="info">
  <p class="title">${null!=(f=e.title)?f:""}</p>
  <p class="titleOrig">${null!=(g=e.title_orig)?g:""}</p>
  <p class="titleOther">${null!=(h=e.other_title)?h:""}</p>
  <p class="links">${buildLinks(e)}</p>
  <p class="string">${buildString(d)}</p>
</div>
</div>
<div class="right">
<button class="right-button iframe-button">\u25b7</button>
<button class="right-button json-button">JSON</button>
</div>
</div>`});return a},sendQuery=async b=>{const a=document.getElementById("status");var d=Date.now();a.textContent="\u041f\u043e\u0438\u0441\u043a\u2026";a.style.display="block";b=await (await fetch(`${"https://api.andb.workers.dev/"}${b}&with_material_data=true`)).json();const {results:c}=b;d=Date.now()-d;return c&&0!==c.length?[c,d]:(a.textContent=`\u041d\u0438\u0447\u0435\u0433\u043e \u043d\u0435 \u043d\u0430\u0439\u0434\u0435\u043d\u043e (${d/1E3} \u0441\u0435\u043a.)`,b.error&&console.log(b.error),
[[],d])};
document.getElementById("new-button").addEventListener("click",async()=>{hash.clear();hash.set("new");const b=document.getElementById("list"),a=document.getElementById("status");b.style.display="none";const [d,c]=await sendQuery("list?types=anime,anime-serial&limit=100");0!==d.length&&(items=new Map([...parse(d.reverse())].reverse()),a.textContent=`\u041d\u0430\u0439\u0434\u0435\u043d\u043e: ${items.size} [${d.length}] (${c/1E3} \u0441\u0435\u043a.)`,b.innerHTML=buildHTML(items),b.style.display="block",
document.getElementById("iframe").dataset.key="")},{passive:!0});const searchForm=document.getElementById("search-form"),searchInput=document.getElementById("search-input");
searchForm.addEventListener("submit",async b=>{b.preventDefault();const {id:a,shikimoriId:d}=b.detail||{id:null,shikimoriId:null};b=!!a||!!d;var c=searchInput.value;if(b||""!==c){b||hash.clear();b=document.getElementById("list");var e=document.getElementById("status");b.style.display="none";c=d?`shikimori_id=${encodeURI(d)}`:a?`id=${encodeURI(a)}`:c.includes("http://www.world-art.ru/cinema/cinema.php?id=")||c.includes("http://www.world-art.ru/animation/animation.php?id=")?`worldart_link=${encodeURI(c)}`:
`title=${encodeURI(c)}`;var [f,g]=await sendQuery(`search?${c}`);0!==f.length&&(items=parse(f),a&&1<f.length&&([[,c]]=items,c.raw.has(a)&&(c.top=c.raw.get(a))),e.textContent=`\u041d\u0430\u0439\u0434\u0435\u043d\u043e: ${items.size} [${f.length}] (${g/1E3} \u0441\u0435\u043a.)`,b.innerHTML=buildHTML(items),b.style.display="block",document.getElementById("iframe").dataset.key="")}});
const list$jscomp$2=document.getElementById("list"),json=document.getElementById("json"),iframe$jscomp$2=document.getElementById("iframe"),jsonOverlay=document.getElementById("json-overlay"),iframeOverlay=document.getElementById("iframe-overlay");
list$jscomp$2.addEventListener("click",({target:b})=>{var {className:a}=b;if(a.includes("iframe-button")||a.includes("json-button")){b=b.parentElement.parentElement;var {key:d}=b.dataset,c=items.get(d);({top:c}=c);a.includes("iframe-button")?(iframe$jscomp$2.dataset.key!==d&&(iframe$jscomp$2.src=c.link,iframe$jscomp$2.dataset.key=d,hash.delete("new"),hash.delete("ep"),hash.set("shikimori",c.shikimori_id),hash.set("id",c.id),a=document.querySelector(".item.current"),a!==b&&(a&&a.classList.remove("current"),
b.classList.add("current"))),iframeOverlay.style.display="block"):a.includes("json-button")&&items.size&&(json.textContent=JSON.stringify(items.get(d),(e,f)=>f instanceof Map?[...f.entries()]:f,"  "),jsonOverlay.style.display="block")}},{passive:!0});const iframeOverlay$jscomp$1=document.getElementById("iframe-overlay"),iframe$jscomp$3=document.getElementById("iframe");
iframeOverlay$jscomp$1.addEventListener("click",({target:b})=>{b===iframeOverlay$jscomp$1&&(iframeOverlay$jscomp$1.style.display="none",iframe$jscomp$3.contentWindow.postMessage({key:"kodik_player_api",value:{method:"pause"}},"*"))},{passive:!0});const jsonOverlay$jscomp$1=document.getElementById("json-overlay");jsonOverlay$jscomp$1.addEventListener("click",({target:b})=>{b===jsonOverlay$jscomp$1&&(jsonOverlay$jscomp$1.style.display="none")},{passive:!0});const iframe$jscomp$4=document.getElementById("iframe");
window.addEventListener("message",({data:b})=>{const {key:a}=iframe$jscomp$4.dataset;if("kodik_player_current_episode"===(null==b?void 0:b.key)){const d=items.get(a);if(null==d?0:d.tr.has(b.value.translation.id)){const c=d.tr.get(b.value.translation.id);d.top=d.raw.get(c);hash.set("id",c);b.value.episode?(hash.set("ep",b.value.episode),document.title=`(${b.value.episode}) ${d.top.title}`):(hash.delete("ep"),document.title=d.top.title);document.querySelector(`.item[data-key="${a}"] .string`).innerHTML=
buildString(d)}}},{passive:!0});const backgroundCount=3,background=document.getElementById("background");document.getElementById("background-button").addEventListener("click",()=>{let b=Math.abs(Number.parseInt(hash.get("bg"),10))||0;b=(b+1)%backgroundCount;background.src=`wallpaper/${b}.mp4`;0===b?hash.delete("bg"):hash.set("bg",b)},{passive:!0});
const background$jscomp$1=document.getElementById("background"),newButton$jscomp$1=document.getElementById("new-button"),iframe$jscomp$5=document.getElementById("iframe"),searchForm$jscomp$1=document.getElementById("search-form");
hash.addCallback(()=>{var b=Math.abs(Number.parseInt(hash.get("bg"),10))||0;const a=b%backgroundCount,d=`wallpaper/${a}.mp4`;d.slice(-15)!==background$jscomp$1.src.slice(-15)&&(background$jscomp$1.src=d);a!==b&&(0!==a?hash.set("bg",a):hash.delete("bg"));if(hash.has("new"))newButton$jscomp$1.click();else{var c=hash.get("id"),e=hash.get("ep");b=hash.get("shikimori");c&&e&&iframe$jscomp$5.addEventListener("load",()=>{let f,g;c===(null==(f=items.get(iframe$jscomp$5.dataset.key))?void 0:null==(g=f.top)?
void 0:g.id)&&iframe$jscomp$5.contentWindow.postMessage({key:"kodik_player_api",value:{method:"change_episode",episode:Number.parseInt(e,10)}},"*")},{once:!0,passive:!0});if(c||b)b=new CustomEvent("submit",{detail:{id:c,shikimoriId:b}}),searchForm$jscomp$1.dispatchEvent(b)}});hash.callCallbacks();window.hash=hash;
//# sourceMappingURL=index.min.js.map
