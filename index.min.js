const e=(()=>{class c extends Map{constructor(){super();this.cache="";this.m();window.addEventListener("hashchange",()=>{this.m()},{passive:!0})}m(){const a=window.location.hash.substring(1);this.cache!==a&&(super.clear(),a&&(a.split("&").forEach(b=>{super.set(...b.split("-",2))}),this.cache=a))}write(){let a="";super.forEach((b,d)=>{a&&(a+="&");a+=`${d}`;"undefined"!==typeof b&&(a+=`-${b}`)});this.cache=a;window.location.hash=a}has(a){return"id"===a?super.has("serial")||super.has("move"):super.has(a)}get(a){if("id"===
a){if(super.has("serial"))return`serial-${super.get("serial")}`;if(super.has("move"))return`move-${super.get("move")}`}return super.get(a)}set(a,b){if("id"===a){if("string"!==typeof b)return this;0===b.indexOf("serial-")?(super.delete("move"),super.set("serial",b.substring(7)),this.write()):0===b.indexOf("move-")&&(super.delete("serial"),super.set("move",b.substring(5)),this.write());return this}super.set(a,b);this.write();return this}delete(a){(a="id"===a?super.delete("serial")||super.delete("move"):
super.delete(a))&&this.write();return a}clear(){const a=super.get("bg");super.clear();a?(super.set("bg",a),this.cache=`bg-${a}`,window.location.hash=`bg-${a}`):(this.cache="",window.location.hash="")}}return new c})(),h=(()=>{const c=(()=>{const b=Array.from({length:255},(d,f)=>f.toString(16).padStart(2,"0"));return d=>(new Uint8Array(d)).reduce((f,g)=>f+b[g],"")})(),a=new Set(["SHA-1","SHA-256","SHA-384","SHA-512"]);return async(b,d="SHA-256",f="hex")=>{d=d.toUpperCase();d=a.has(d)?d:"SHA-256";b=
(new TextEncoder).encode(b);b=await crypto.subtle.digest(d,b);return"base64"===f?btoa(String.fromCharCode.apply(null,new Uint8Array(b))):c(b)}})();let l=new Map;
const m=(()=>{const c=["nyaa","kawai","moe","desu","dere"];return a=>(a=a.s)?`https://${c[a%c.length]}.shikimori.me/system/animes/original/${a}.jpg?${1650095057+ +a}`:"no-img.jpg"})(),n=async c=>{const a=new Map;await Promise.all(c.map(async b=>{const d=await h(b.A||b.B||b.s||b.D||`${b.type}${b.year}${b.v}`);a.has(d)?a.get(d).top.g<b.g&&(a.get(d).top=b,a.get(d).i=b.g):a.set(d,{key:d,u:m(b),y:b.year,i:b.g,top:b,raw:new Map,l:new Map});a.get(d).raw.set(b.id,b);a.get(d).l.set(b.h.id,b.id)}));return a},
p=c=>{const a=c.top;let b="";c.y&&(b+=`${c.y}\u0433. `);c.i&&(b+=`${c.i} \u044d\u043f. `);let d="";c.raw.forEach(f=>{""!==d&&(d+=", ");f===a?d+=`<span class="underline">${f.h.title}</span>`:d+=f.h.title;f.g&&(d+=`[${f.g}]`)});return b+d},q=()=>{let c="";l.forEach((a,b)=>{const d=a.top;let f,g,k;c+=`<div class="item" data-key="${b}">
<div class="left">
<div class="poster-wrapper">
  <img class="poster" src="${a.u}" alt="" />
</div>
<div class="info">
  <p class="title">${null!=(f=d.title)?f:""}</p>
  <p class="titleOrig">${null!=(g=d.v)?g:""}</p>
  <p class="titleOther">${null!=(k=d.C)?k:""}</p>
  <p class="string">${p(a)}</p>
</div>
</div>
<div class="right">
<button class="right-button iframe-button">\u25b7</button>
<button class="right-button json-button">JSON</button>
</div>
</div>`});return c},r=async c=>{const a=document.getElementById("status");var b=Date.now();a.textContent="\u041f\u043e\u0438\u0441\u043a\u2026";a.style.display="block";c=await (await fetch(`${"https://metamedia.glitch.me/api/"}${c}`)).json();const d=c.results;b=Date.now()-b;return d&&0!==d.length?[d,b]:(a.textContent=`\u041d\u0438\u0447\u0435\u0433\u043e \u043d\u0435 \u043d\u0430\u0439\u0434\u0435\u043d\u043e (${b/1E3} \u0441\u0435\u043a.)`,c.error&&console.log(c.error),[[],b])},t=document.getElementById("background"),
u=Number.parseInt(e.get("bg"),10),v=u%3;v?(t.src=`wallpaper/${v}.mp4`,v!==u&&e.set("bg",v)):e.delete("bg");document.getElementById("background-button").addEventListener("click",()=>{let c=Number.parseInt(e.get("bg"),10)||0;c=(c+1)%3;t.src=`wallpaper/${c}.mp4`;0===c?e.delete("bg"):e.set("bg",c)},{passive:!0});
document.getElementById("new-button").addEventListener("click",async()=>{e.clear();e.set("new");const c=document.getElementById("list"),a=document.getElementById("status");c.style.display="none";var b=await r("list?types=anime,anime-serial&limit=100");const [d,f]=b;0!==d.length&&(b=await n(d.reverse()),l=new Map([...b].reverse()),a.textContent=`\u041d\u0430\u0439\u0434\u0435\u043d\u043e: ${l.size} [${d.length}] (${f/1E3} \u0441\u0435\u043a.)`,c.innerHTML=q(),c.style.display="block")},{passive:!0});
const w=document.getElementById("search-form"),x=document.getElementById("search-input");
w.addEventListener("submit",async c=>{c.preventDefault();const {id:a,o:b}=c.detail||{id:null,o:null};c=!!a||!!b;var d=x.value;if(c||""!==d){c||e.clear();c=document.getElementById("list");var f=document.getElementById("status");c.style.display="none";d=b?`shikimori_id=${encodeURI(b)}`:a?`id=${encodeURI(a)}`:d.includes("http://www.world-art.ru/cinema/cinema.php?id=")||d.includes("http://www.world-art.ru/animation/animation.php?id=")?`worldart_link=${encodeURI(d)}`:`title=${encodeURI(d)}`;d=await r(`search?${d}`);
var [g,k]=d;0!==g.length&&(l=await n(g),a&&1<g.length&&([[,d]]=l,d.raw.has(a)&&(d.top=d.raw.get(a))),f.textContent=`\u041d\u0430\u0439\u0434\u0435\u043d\u043e: ${l.size} [${g.length}] (${k/1E3} \u0441\u0435\u043a.)`,c.innerHTML=q(),c.style.display="block")}});const y=document.getElementById("list"),z=document.getElementById("json"),A=document.getElementById("iframe"),B=document.getElementById("json-overlay"),C=document.getElementById("iframe-overlay");
y.addEventListener("click",({target:c})=>{var a=c.className;if(a.includes("iframe-button")||a.includes("json-button")){c=c.parentElement.parentElement;var b=c.dataset.key,d=l.get(b).top;a.includes("iframe-button")?(A.dataset.key!==b&&(A.src=d.link,A.dataset.key=b,e.delete("new"),e.set("shikimori",d.s),e.set("id",d.id),a=document.querySelector(".item.current"),a!==c&&(a&&a.classList.remove("current"),c.classList.add("current"))),C.style.display="block"):a.includes("json-button")&&l.size&&(z.textContent=
JSON.stringify(l.get(b),(f,g)=>g instanceof Map?[...g.entries()]:g,"  "),B.style.display="block")}},{passive:!0});const D=document.getElementById("iframe-overlay"),E=document.getElementById("iframe");D.addEventListener("click",({target:c})=>{c===D&&(D.style.display="none",E.contentWindow.postMessage({key:"kodik_player_api",value:{method:"pause"}},"*"))},{passive:!0});const F=document.getElementById("json-overlay");F.addEventListener("click",({target:c})=>{c===F&&(F.style.display="none")},{passive:!0});
e.has("new")&&document.getElementById("new-button").click();if(e.has("id")&&e.has("ep")){const c=document.getElementById("iframe");c.addEventListener("load",()=>{let a,b;(null==(a=l.get(c.dataset.key))?void 0:null==(b=a.top)?void 0:b.id)===e.get("id")&&c.contentWindow.postMessage({key:"kodik_player_api",value:{method:"change_episode",j:Number.parseInt(e.get("ep"),10)}},"*")},{once:!0,passive:!0})}const G=e.get("id"),H=e.get("shikimori");
if(G||H){const c=new CustomEvent("submit",{detail:{id:G,o:H}});document.getElementById("search-form").dispatchEvent(c)}const I=document.getElementById("iframe");
window.addEventListener("message",({data:c})=>{const a=I.dataset.key;if("kodik_player_current_episode"===(null==c?void 0:c.key)){const b=l.get(a);if(null==b?0:b.l.has(c.value.h.id)){const d=b.l.get(c.value.h.id);b.top=b.raw.get(d);e.set("id",d);c.value.j?(e.set("ep",c.value.j),document.title=`(${c.value.j}) ${b.top.title}`):(e.delete("ep"),document.title=b.top.title);document.querySelector(`.item[data-key="${a}"] .string`).innerHTML=p(b)}}},{passive:!0});
